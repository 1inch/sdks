name: Publish

on:
  push:
    tags:
      - '*/v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        type: string
        description: Tag to publish (e.g. aqua/v1.2.3)
        required: true
      dry_run:
        type: boolean
        description: Dry run (preview publish commands)
        required: false
        default: false

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  determine:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.value }}
      project: ${{ steps.project.outputs.value }}
      sdk_path: ${{ steps.project.outputs.sdk_path }}
      package_name: ${{ steps.project.outputs.package_name }}
    steps:
      - id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.value }}
          fetch-depth: 1

      - id: project
        run: |
          TAG="${{ steps.tag.outputs.value }}"

          PROJECT="${TAG%%/v*}"
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "$TAG" ]; then
            echo "Unable to derive project from tag: $TAG"
            exit 1
          fi

          echo "value=$PROJECT" >> "$GITHUB_OUTPUT"
          SDK_PATH="typescript/$PROJECT"
          echo "sdk_path=$SDK_PATH" >> "$GITHUB_OUTPUT"
          PKG_NAME=$(node -p "require('./$SDK_PATH/package.json').name")
          echo "package_name=$PKG_NAME" >> "$GITHUB_OUTPUT"

  publish:
    needs: determine
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      PUBLISH_DRY_RUN: ${{ inputs.dry_run || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.determine.outputs.tag }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org
          always-auth: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package (pnpm)
        run: pnpm --filter "${{ needs.determine.outputs.package_name }}" build

      - name: Publish to npmjs
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          SDK_PATH=${{ needs.determine.outputs.sdk_path }}
          cd "$SDK_PATH/dist"

          TAG_ARG=""
          VERSION=$(node -p "require('../package.json').version")
          if [[ "$VERSION" == *"-rc"* ]]; then
            TAG_ARG="--tag next"
          fi
          DRY_ARG=$([ "$PUBLISH_DRY_RUN" = "true" ] && echo "--dry-run")
          npm publish --access public $TAG_ARG $DRY_ARG

      - name: Publish to GitHub Packages
        env:
          NODE_AUTH_TOKEN: ${{ github.token }}
        run: |
          SDK_PATH=${{ needs.determine.outputs.sdk_path }}
          cd "$SDK_PATH/dist"

          npm config set @1inch:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken "${NODE_AUTH_TOKEN}"
          DRY_ARG=$([ "$PUBLISH_DRY_RUN" = "true" ] && echo "--dry-run")
          npm publish --access public $DRY_ARG
